unit UImprimirRelatorio;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Data.DB, Data.Win.ADODB,
  frxClass, frxDBSet, Vcl.Imaging.pngimage, Vcl.ExtCtrls;

type
  TfrmGerarRelatorio = class(TForm)
    cbxCrianca: TComboBox;
    cbxMes: TComboBox;
    cbxAno: TComboBox;
    Label1: TLabel;
    Label2: TLabel;
    btnImprimirRelatorio: TButton;
    lblTitulo: TLabel;
    qryRelatorio: TADOQuery;
    qryReport: TADOQuery;
    dtsReport: TDataSource;
    relatorio: TfrxReport;
    dtsFrx: TfrxDBDataset;
    Image1: TImage;
    dtsCabecalho: TfrxDBDataset;
    dtsCab: TDataSource;
    procedure FormCreate(Sender: TObject);
    procedure pesquisarCriancas;
    procedure btnImprimirRelatorioClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure montaVisitas;
    procedure montaCabecalho;
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmGerarRelatorio: TfrmGerarRelatorio;

implementation

{$R *.dfm}

uses UMenu, uSelVisitas;

procedure TfrmGerarRelatorio.btnImprimirRelatorioClick(Sender: TObject);
    begin
      if (cbxMes.ItemIndex<>0) and (cbxAno.ItemIndex<>0) then
       begin

       frmSelecionarRel:=TfrmSelecionarRel.Create(self,cbxAno.Text,cbxMes.Text,inttostr(Integer(cbxCrianca.items.objects[cbxCrianca.ItemIndex])));
       frmSelecionarRel.ShowModal;

      { montaVisitas;
       montaCabecalho;
       relatorio.Variables['mes']:= '''' + cbxMes.Text + '''';
       relatorio.Variables['ano']:= '''' + cbxAno.Text + '''';
       relatorio.ShowReport;   }
      end
      else
        ShowMessage('Escolha o mes e ano');

    end;

procedure TfrmGerarRelatorio.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
   Action := caFree;
end;

procedure TfrmGerarRelatorio.FormCreate(Sender: TObject);
    begin
        pesquisarCriancas;
    end;

procedure TfrmGerarRelatorio.montaCabecalho;
begin
    qryRelatorio.Close;
    with qryRelatorio.SQL do
    begin
      clear;
      add('SELECT *                                                                              ');
      add('FROM vwCabecalhoRel c                                                                 ');
      add('WHERE c.idCrianca = '+inttostr(Integer(cbxCrianca.items.objects[cbxCrianca.ItemIndex])));
      add('and c.idVisitador='+frmMenu.idUsuario);
    end;

    qryRelatorio.Open
end;

procedure TfrmGerarRelatorio.montaVisitas;
begin
          qryReport.Close;
          with qryReport.SQL do
          begin
            Clear;
            Add('select g.idGrupo,g.nomeGrupo');
            Add(',v.idVisita,v.acolhimento,v.desenvolvimento,v.momentoFinal,v.objetivo, v.mesVisita,v.anoVisita');
            Add(',c.nomeCrianca,c.nisCrianca,c.dtNascCrianca, C.territorioCrianca');
            Add(',DATEDIFF(YEAR,c.dtNascCrianca,GETDATE()) as idadeCrianca');
            Add(',s.nomeSupervisor');
            Add(',vi.nomeVisitador');
            Add('from grupo g');
            Add('inner join visita v on v.idGrupo=g.idGrupo');
            Add('inner join crianca c on g.idGrupo=c.idGrupo');
            Add('inner join visitador vi on g.idVisitador=vi.idVisitador');
            Add('inner join supervisor s on vi.idSupervisor=s.idSupervisor');
            Add('where g.idVisitador='+frmMenu.idUsuario);
            Add('and c.idCrianca='+inttostr(Integer(cbxCrianca.items.objects[cbxCrianca.ItemIndex])));
            Add('and v.mesVisita='+QuotedStr(cbxMes.Text));
            Add('and v.anoVisita='+QuotedStr(cbxAno.Text));
         end;
end;

procedure TfrmGerarRelatorio.pesquisarCriancas;
var i:integer;
    begin
        qryRelatorio.Close;
        with   qryRelatorio do
        begin
          qryRelatorio.SQL.Add('select c.idCrianca, c.nomeCrianca, c.territorioCrianca from crianca c');
          qryRelatorio.SQL.Add('inner join grupo g on c.idGrupo=g.idGrupo');
          qryRelatorio.SQL.Add('where g.idVisitador='+quotedStr(frmMenu.idUsuario));
        end;
        qryRelatorio.Open;

        i:=0;
       while i<qryRelatorio.RecordCount do
       begin
         cbxCrianca.Items.AddObject( qryRelatorio.FieldByName('nomeCrianca').asString+'-'+qryRelatorio.FieldByName('territorioCrianca').asString,
          tObject(qryRelatorio.FieldByName('idCrianca').asInteger) );
         qryRelatorio.Next;
         i:=i+1;
       end;
       cbxCrianca.ItemIndex:=0;
    end;

end.
